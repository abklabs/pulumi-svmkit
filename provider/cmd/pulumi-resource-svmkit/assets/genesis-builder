#!/usr/bin/env bash

set -euo pipefail
SCRIPTDIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

. "$SCRIPTDIR/lib.bash"

ARCHIVE_FNAME=$1 ; shift
TARGET_DIR=$1 ; shift

cat<<EOF > run-genesis
#!/usr/bin/env bash

$SUDO chmod +x $TARGET_DIR/genesis

LEDGER_PATH=$LEDGER_PATH \
IDENTITY_PUBKEY=$IDENTITY_PUBKEY \
VOTE_PUBKEY=$VOTE_PUBKEY \
STAKE_PUBKEY=$STAKE_PUBKEY \
FAUCET_PUBKEY=$FAUCET_PUBKEY \
FAUCET_LAMPORTS=$FAUCET_LAMPORTS \
TARGET_LAMPORTS_PER_SIGNATURE=$TARGET_LAMPORTS_PER_SIGNATURE \
INFLATION=$INFLATION \
LAMPORTS_PER_BYTE_YEAR=$LAMPORTS_PER_BYTE_YEAR \
SLOT_PER_EPOCH=$SLOT_PER_EPOCH \
CLUSTER_TYPE=$CLUSTER_TYPE \
exec "$TARGET_DIR/genesis"
EOF


chmod 755 run-genesis

(cd "$SCRIPTDIR/.." && tar cvzf "$ARCHIVE_FNAME" $(basename "$SCRIPTDIR"))
