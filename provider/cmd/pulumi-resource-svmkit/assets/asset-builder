#!/usr/bin/env bash

set -euo pipefail
SCRIPTDIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
. "$SCRIPTDIR/lib.bash"

ARCHIVE_FNAME=$1 ; shift

touch validator-keypair.json vote-account-keypair.json
chmod 600 validator-keypair.json vote-account-keypair.json
echo "$IDENTITY_KEYPAIR" > validator-keypair.json
echo "$VOTEACCOUNT_KEYPAIR" > vote-account-keypair.json

touch env

add-to-env () {
    local varname
    varname=$1 ; shift

    if [[ -v $varname ]] ; then
	printf "%s=\"%s\"\n" "$varname" "${!varname}" >> env
    fi
}

add-to-env VALIDATOR_VARIANT
add-to-env VALIDATOR_FLAGS

(cd "$SCRIPTDIR/.." && tar cvzf "$ARCHIVE_FNAME" $(basename "$SCRIPTDIR"))
